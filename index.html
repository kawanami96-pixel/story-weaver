<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryWeaver v11.0 æ±ºå®šç‰ˆ</title>
    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š -->
    <style>
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ (ã‚¤ãƒ³ãƒ‡ã‚£ã‚´/ãƒ©ã‚¤ãƒˆãƒ›ãƒ©ãƒ¼) */
        :root { --bg-main: #0f172a; --bg-card: #1e293b; --accent: #4f46e5; --accent-glow: rgba(79, 70, 229, 0.5); --text-main: #e2e8f0; }
        
        /* ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆãƒ†ãƒ¼ãƒ (ãƒ”ãƒ³ã‚¯/R-15) */
        body.midnight-mode { 
            --bg-main: #1a0510; --bg-card: #2d0a18; --accent: #db2777; --accent-glow: rgba(219, 39, 119, 0.5); --text-main: #fce7f3; 
        }
        
        body { 
            background-color: var(--bg-main); color: var(--text-main); font-family: 'Noto Sans JP', sans-serif; 
            overflow: hidden; transition: background-color 0.5s; 
            height: 100dvh; 
        }
        .font-serif { font-family: 'Shippori Mincho', serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .accent-bg { background-color: var(--accent); }
        .accent-text { color: var(--accent); }
        
        /* Loading Overlay Logic (The Fix for Freezing) */
        #loading-overlay { 
            position: fixed; inset: 0; background: var(--bg-main); z-index: 5000; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 0.3s; 
        }
        #loading-overlay.hidden-overlay { opacity: 0; pointer-events: none; }
        
        /* Visual Panel */
        #visual-panel {
            position: fixed; inset-x: 0; bottom: 0; height: 80vh; 
            background-color: var(--bg-main); 
            border-top: 1px solid var(--bg-card);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        #visual-panel.show-panel { transform: translateY(0%); }
    </style>
</head>
<body class="flex flex-col">
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4 shadow-[0_0_15px_rgba(79,70,229,0.5)]"></div>
        <p class="text-sm font-bold animate-pulse mb-8 tracking-widest text-indigo-300" id="loading-text">SYSTEM INITIALIZING...</p>
        <div class="flex flex-col gap-4 items-center opacity-0 transition-opacity duration-1000" id="loading-fallback">
            <button onclick="forceLocalMode()" class="text-xs text-gray-500 border border-gray-700 px-4 py-2 rounded hover:bg-gray-800">å¼·åˆ¶èµ·å‹• (Force Start)</button>
        </div>
    </div>

    <!-- Header -->
    <header class="h-14 flex-none border-b border-gray-800 flex items-center justify-between px-4 z-20" style="background-color: var(--bg-card);">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('library')">
            <i data-lucide="library" class="w-5 h-5 accent-text"></i>
            <span class="font-serif font-bold text-lg text-gray-100">StoryWeaver</span>
            <span id="mode-badge" class="text-[9px] px-1.5 py-0.5 rounded border border-gray-600 text-gray-400">v11.0</span>
        </div>
        <div class="flex gap-3">
            <button onclick="panicMode()" class="text-xs text-gray-600 font-bold hidden border border-gray-800 bg-black/20 px-2 rounded" id="panic-btn">BOSS KEY</button>
            <button onclick="$('settings-modal').classList.remove('hidden')" class="text-xs text-gray-400 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </header>

    <!-- Main Screens -->
    <main class="flex-grow relative overflow-hidden">
        <!-- 1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç”»é¢ -->
        <div id="screen-library" class="absolute inset-0 overflow-y-auto p-4 space-y-4 z-10 hidden" style="background-color: var(--bg-main);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-200">æ›¸åº«</h2>
                <button onclick="openCreateModal()" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95"><i data-lucide="plus" class="w-4 h-4"></i> æ–°è¦ä½œæˆ</button>
            </div>
            <div id="library-list" class="grid grid-cols-2 gap-4 pb-20 md:grid-cols-3 lg:grid-cols-4"></div>
        </div>

        <!-- 2. ã‚­ãƒ£ã‚¹ãƒˆè¨­å®šç”»é¢ -->
        <div id="screen-char-studio" class="absolute inset-0 flex flex-col translate-x-full transition-transform duration-300 z-30 hidden" style="background-color: var(--bg-main);">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center" style="background-color: var(--bg-card);">
                <h2 class="font-bold accent-text flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š</h2>
                <button onclick="finishCharSetup()" class="text-xs accent-bg px-3 py-1 rounded text-white">åŸ·ç­†ã¸é€²ã‚€</button>
            </div>
            <div class="p-2 border-b border-gray-800 space-y-2">
                <button onclick="aiSuggestChars()" id="ai-char-btn" class="w-full py-2 bg-gray-800 border border-gray-600 accent-text rounded text-xs flex items-center justify-center gap-2 transition-colors hover:bg-gray-700"><i data-lucide="sparkles" class="w-3 h-3"></i> AIææ¡ˆ (Groq)</button>
            </div>
            <div id="char-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-20"></div>
            <div class="p-4 pb-safe border-t border-gray-800" style="background-color: var(--bg-card);">
                <button onclick="addEmptyChar()" class="w-full py-2 bg-gray-800 text-gray-400 rounded text-xs border border-dashed border-gray-600 hover:bg-gray-700">+ æ‰‹å‹•ã§è¿½åŠ </button>
            </div>
        </div>

        <!-- 3. åŸ·ç­†ã‚¹ã‚¿ã‚¸ã‚ªç”»é¢ -->
        <div id="screen-studio" class="absolute inset-0 flex flex-col translate-x-full transition-transform duration-300 z-20 hidden" style="background-color: var(--bg-main);">
            <div id="studio-content" class="flex-grow overflow-y-auto p-4 pb-32 font-serif scrollbar-hide"></div>
            
            <div id="new-char-alert" class="absolute bottom-20 left-4 right-4 bg-gray-800 border border-yellow-500/50 p-3 rounded-lg shadow-xl flex items-center justify-between hidden slide-up">
                <div class="text-xs text-yellow-100">æ–°ã‚­ãƒ£ãƒ©ç™ºè¦‹: <span id="new-char-name" class="font-bold"></span></div>
                <button onclick="acceptNewChar()" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">è¿½åŠ </button>
            </div>

            <!-- Editor Controls -->
            <div id="edit-controls" class="absolute bottom-0 w-full glass-panel pb-safe" style="background-color: var(--bg-card);">
                <div class="flex gap-2 p-2 overflow-x-auto border-b border-gray-700 scrollbar-hide items-center">
                     <button onclick="openCharStudio()" class="flex-shrink-0 px-3 py-1 bg-gray-800 accent-text rounded text-xs border border-gray-600 hover:bg-gray-700">ã‚­ãƒ£ã‚¹ãƒˆ</button>
                     <button onclick="toggleVisualTab()" class="flex-shrink-0 px-3 py-1 bg-gray-800 text-pink-400 rounded text-xs border border-gray-600 hover:bg-gray-700">æŒ¿çµµ</button>
                     
                     <!-- Sensory Slider -->
                     <div id="sensory-control" class="hidden flex items-center gap-2 px-2 border-l border-gray-600 ml-2">
                        <span class="text-[10px] text-pink-300 font-bold">æ·±åº¦</span>
                        <input type="range" id="sensory-level" min="1" max="3" value="1" class="w-16 accent-pink-500 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <span id="sensory-label" class="text-[10px] text-pink-300">æ¨™æº–</span>
                     </div>
                </div>
                <div class="flex gap-2 p-3 items-end">
                    <textarea id="user-input" rows="1" class="flex-grow bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 outline-none resize-none text-white placeholder-gray-500 min-h-[44px]" placeholder="å±•é–‹ã‚’æŒ‡ç¤º..."></textarea>
                    <button id="send-btn" class="w-12 h-12 accent-bg rounded-full flex items-center justify-center text-white shadow-lg transform active:scale-95 transition-transform"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </main>

    <!-- 4. Visual Panel (Fixed) -->
    <div id="visual-panel">
        <div class="p-3 flex justify-between items-center flex-none" style="background-color: var(--bg-card);">
            <span class="text-xs font-bold text-pink-400 flex items-center gap-2"><i data-lucide="image" class="w-4 h-4"></i> æŒ¿çµµã‚¹ã‚¿ã‚¸ã‚ª (Pollinations)</span>
            <button onclick="toggleVisualTab()" class="text-gray-400 p-1 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <!-- Controls -->
        <div class="p-3 border-b border-gray-800 grid grid-cols-2 gap-2 flex-none">
            <select id="visual-model" class="bg-gray-900 border border-gray-700 text-xs rounded p-1 text-gray-300">
                <option value="flux">Flux (é«˜ç”»è³ªãƒ»ä¸‡èƒ½)</option>
                <option value="any-dark">Any Dark (ãƒ›ãƒ©ãƒ¼ãƒ»æš—é»’)</option>
                <option value="turbo">Turbo (é«˜é€Ÿãƒ»ãƒ©ãƒ•)</option>
            </select>
            <select id="visual-aspect" class="bg-gray-900 border border-gray-700 text-xs rounded p-1 text-gray-300">
                <option value="16:9">æŒ¿çµµ (16:9)</option>
                <option value="9:16">ç«‹ã¡çµµ (9:16)</option>
                <option value="1:1">æ­£æ–¹å½¢ (1:1)</option>
                <option value="4:3">è¨­å®šç”» (4:3)</option>
            </select>
            <!-- Midnight Controls -->
            <select id="visual-costume" class="bg-gray-900 border border-pink-900 text-xs rounded p-1 text-pink-200 hidden">
                <option value="normal">è¡£è£…: é€šå¸¸</option>
                <option value="half">è¡£è£…: ç€å´©ã—</option>
                <option value="lingerie">è¡£è£…: ä¸‹ç€</option>
                <option value="nude">è¡£è£…: ç´ ä½“</option>
            </select>
            <select id="visual-camera" class="bg-gray-900 border border-pink-900 text-xs rounded p-1 text-pink-200 hidden">
                <option value="normal">è¦–ç‚¹: æ¨™æº–</option>
                <option value="face">è¦–ç‚¹: è¡¨æƒ…(Face)</option>
                <option value="pov">è¦–ç‚¹: è¦‹ä¸‹ã‚ã—(POV)</option>
                <option value="body">è¦–ç‚¹: èº«ä½“(Body)</option>
            </select>
        </div>
        
        <!-- Character Chips -->
        <div class="p-2 border-b border-gray-800 flex gap-2 overflow-x-auto flex-none whitespace-nowrap scrollbar-hide" id="visual-char-chips"></div>
        
        <!-- Prompt Input and Button -->
        <div class="p-2 border-b border-gray-800 flex gap-2 items-center flex-none">
            <input id="visual-custom-prompt" class="flex-grow bg-gray-900 border border-gray-700 rounded px-2 py-2 text-xs text-white" placeholder="çŠ¶æ³ (ä¾‹: ç¬‘ã£ã¦ã„ã‚‹, é›¨ã®ä¸­)">
            <button onclick="generateWithChar()" class="bg-pink-600 text-white px-4 py-2 rounded text-xs font-bold whitespace-nowrap shadow-lg active:scale-95 hover:bg-pink-500">ç”Ÿæˆ</button>
        </div>
        
        <div id="visual-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-safe bg-black">
            <p class="text-gray-600 text-center text-sm">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <!-- Create Modal -->
    <div id="create-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-3">
            <h3 class="font-bold text-center text-gray-200 mb-2">æ–°è¦ä½œæˆ</h3>
            <input id="new-title" class="w-full bg-black border border-slate-700 rounded p-2 text-sm text-white focus:border-indigo-500 outline-none" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <select id="new-genre" class="w-full bg-black border border-slate-700 rounded p-2 text-xs text-gray-300">
                <option>ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option><option>ç•°ä¸–ç•Œè»¢ç”Ÿ</option><option>SF/ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯</option><option>ç¾ä»£ãƒ‰ãƒ©ãƒ/å­¦åœ’</option><option>ãƒ›ãƒ©ãƒ¼/ãƒŸã‚¹ãƒ†ãƒªãƒ¼</option><option>ãã®ä»–</option>
            </select>
            <select id="new-tone" class="w-full bg-black border border-slate-700 rounded p-2 text-xs text-gray-300">
                <option value="æ¨™æº–">æ–‡ä½“: æ¨™æº–</option><option value="ãƒ©ãƒãƒ™é¢¨(è»½å¿«)">æ–‡ä½“: ãƒ©ãƒãƒ™é¢¨(è»½å¿«)</option><option value="æ–‡è±ªé¢¨(é‡åš)">æ–‡ä½“: æ–‡è±ªé¢¨(é‡åš)</option><option value="å®˜èƒ½å°èª¬é¢¨">æ–‡ä½“: å®˜èƒ½çš„/ã‚·ãƒªã‚¢ã‚¹</option>
            </select>
            <textarea id="new-plot" rows="3" class="w-full bg-black border border-slate-700 rounded p-2 text-sm text-white focus:border-indigo-500 outline-none" placeholder="ã‚ã‚‰ã™ã˜"></textarea>
            <button onclick="startNewStory()" class="w-full py-3 accent-bg text-white font-bold rounded-lg hover:opacity-90">æ¬¡ã¸</button>
            <button onclick="$('create-modal').classList.add('hidden')" class="w-full py-2 text-gray-500 text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-center text-gray-200">è¨­å®š</h3>
            <div>
                <label class="text-xs font-bold text-orange-400">ğŸ”¥ Groq API Key</label>
                <input type="password" id="key-groq" onchange="applyMidnightTheme()" class="w-full bg-black border border-slate-700 rounded p-2 mt-1 text-xs text-white focus:border-orange-500 outline-none">
            </div>
            <div class="bg-slate-800 p-3 rounded border border-yellow-500/30">
                <label class="text-xs font-bold text-yellow-400">âš¡ Firebase Config</label>
                <textarea id="firebase-config" rows="4" class="w-full bg-black border border-slate-700 rounded p-2 text-[10px] font-mono text-gray-300 focus:border-yellow-500 outline-none" placeholder="{ apiKey: ... }"></textarea>
            </div>
            
            <!-- Midnight Switch -->
            <div class="flex items-center justify-between bg-black p-3 rounded border border-pink-900/50">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-pink-400">ç´³å£«ãƒ¢ãƒ¼ãƒ‰</span>
                    <span class="text-[10px] text-gray-500">Midnight Mode (R-18 Features)</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="midnight-toggle" class="sr-only peer" onchange="applyMidnightTheme()">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                </label>
            </div>

            <div class="flex gap-2">
                <button onclick="saveSettings(false)" class="flex-grow py-3 accent-bg text-white font-bold rounded-lg text-xs hover:opacity-90">ä¿å­˜</button>
                <button onclick="saveSettings(true)" class="flex-grow py-3 bg-slate-700 text-white font-bold rounded-lg text-xs border border-slate-500 hover:bg-slate-600">ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½¿ã†</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // GlobalãªFirebaseæ“ä½œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        window.FB = { 
            available: false,
            init: (config) => { 
                try { 
                    const app = initializeApp(config); 
                    window.db = getFirestore(app); 
                    window.FB.available = true; 
                    return true; 
                } catch(e) { console.error("FB Init:", e); return false; } 
            },
            getLibrary: async () => { 
                if(!window.FB.available) return JSON.parse(localStorage.getItem('local_stories') || '[]'); 
                const q = query(collection(window.db, "stories"), orderBy("updatedAt", "desc")); 
                const snap = await getDocs(q); 
                return snap.docs.map(d => ({id: d.id, ...d.data()})); 
            },
            createStory: async (data) => { 
                const d = { ...data, createdAt: new Date(), updatedAt: new Date() }; 
                if(window.FB.available) { 
                    const ref = await addDoc(collection(window.db, "stories"), { ...d, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); 
                    return ref.id; 
                } 
                const id = 'loc_'+Date.now(); 
                const s = JSON.parse(localStorage.getItem('local_stories')||'[]'); 
                s.unshift({id, ...d}); 
                localStorage.setItem('local_stories', JSON.stringify(s)); 
                return id; 
            },
            saveStory: async (id, data) => { 
                if(window.FB.available && !id.startsWith('loc_')) { 
                    await updateDoc(doc(window.db, "stories", id), { ...data, updatedAt: serverTimestamp() }); 
                } else { 
                    const s = JSON.parse(localStorage.getItem('local_stories')||'[]'); 
                    const i = s.findIndex(x=>x.id===id); 
                    if(i!==-1) { 
                        s[i]={...s[i], ...data, updatedAt: new Date()}; 
                        localStorage.setItem('local_stories', JSON.stringify(s)); 
                    } 
                } 
            },
            getStory: async (id) => { 
                if(window.FB.available && !id.startsWith('loc_')) { 
                    const s = await getDoc(doc(window.db, "stories", id)); 
                    return s.exists() ? s.data() : null; 
                } 
                return JSON.parse(localStorage.getItem('local_stories')||'[]').find(x=>x.id===id)||null; 
            }
        };
        window.dispatchEvent(new Event('fb-ready'));
    </script>
    <script>
        lucide.createIcons();
        
        // --- Robust Element Selector ---
        const $ = (id) => { 
            const el = document.getElementById(id); 
            if (el) return el;
            return { 
                style: {}, classList: { remove:()=>{}, add:()=>{}, toggle:()=>{}, contains:()=>false }, 
                value: '', innerText: '', innerHTML: '', checked: false, disabled: false,
                addEventListener: ()=>{}
            }; 
        };

        // --- Loader Logic (The Fix) ---
        function toggleLoading(show, text = "LOADING...") {
            const overlay = $('loading-overlay');
            const txt = $('loading-text');
            
            if (show) {
                txt.innerText = text;
                overlay.classList.remove('hidden-overlay');
            } else {
                overlay.classList.add('hidden-overlay');
            }
        }

        setTimeout(() => {
            if (!$('loading-overlay').classList.contains('hidden-overlay')) {
                $('loading-fallback').style.opacity = '1';
            }
        }, 5000);

        let appData = { keys: {}, currentStory: null, mode: 'edit' };
        const SENSORY_LABELS = { "1": "æ¨™æº–", "2": "å¿ƒç†çš„", "3": "éœ²éª¨" };


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => { 
            if (window.FB && window.FB.init) initApp(); else window.addEventListener('fb-ready', initApp); 
            
            // Event Listeners
            $('midnight-toggle').addEventListener('change', applyMidnightTheme);
            $('sensory-level').addEventListener('input', () => { $('sensory-label').innerText = SENSORY_LABELS[$('sensory-level').value]; });
            $('send-btn').addEventListener('click', () => { generateStoryLogic($('user-input').value.trim()); });
            
            // Safety net: ensure init happens eventually
            setTimeout(() => { if($('loading-overlay').classList.contains('hidden-overlay') === false) initApp(); }, 3000); 
        });

        async function initApp() {
            try {
                const saved = localStorage.getItem('story_weaver_v10_config');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    appData.keys = parsed.keys || {};
                    $('key-groq').value = appData.keys.groq || '';
                    $('firebase-config').value = appData.keys.firebaseRaw || '';
                    $('midnight-toggle').checked = appData.keys.midnight || false;
                    
                    applyMidnightTheme();

                    if(appData.keys.firebaseRaw && !appData.keys.useLocal) {
                        try {
                            let raw = appData.keys.firebaseRaw.trim();
                            if(!raw.startsWith('{')) raw = '{' + raw + '}';
                            const conf = (new Function("return " + raw))(); 
                            window.FB.init(conf);
                            updateBadge("CLOUD", "text-green-400");
                        } catch(e) { updateBadge("LOCAL", "text-red-400"); }
                    } else { updateBadge("LOCAL", "text-gray-400"); }
                    
                    await loadLibrary();
                    // SUCCESS: Hide loader
                    toggleLoading(false);
                } else {
                    // NO CONFIG: Hide loader, show settings
                    toggleLoading(false);
                    $('settings-modal').classList.remove('hidden');
                }
            } catch(e) { 
                console.error(e);
                toggleLoading(false); 
                $('settings-modal').classList.remove('hidden'); 
            }
        }

        function updateBadge(txt, col) { $('mode-badge').innerText = `v11.0 ${txt}`; $('mode-badge').className = `text-[9px] px-1.5 py-0.5 rounded border border-gray-600 ${col}`; }
        
        // --- Midnight Mode Logic ---
        function applyMidnightTheme() {
            const isMidnight = $('midnight-toggle').checked;
            if (isMidnight) {
                document.body.classList.add('midnight-mode');
                $('visual-costume').classList.remove('hidden');
                $('visual-camera').classList.remove('hidden');
                $('sensory-control').classList.remove('hidden');
                $('panic-btn').classList.remove('hidden');
            } else {
                document.body.classList.remove('midnight-mode');
                $('visual-costume').classList.add('hidden');
                $('visual-camera').classList.add('hidden');
                $('sensory-control').classList.add('hidden');
                $('panic-btn').classList.add('hidden');
            }
            appData.keys.midnight = isMidnight;
        }

        window.panicMode = () => {
            document.body.innerHTML = `<div class="p-4 bg-white text-black h-screen font-sans">
                <div class="flex gap-2 mb-4"><span class="text-blue-600 font-bold text-xl">G</span><span class="text-red-500 font-bold text-xl">o</span><span class="text-yellow-500 font-bold text-xl">o</span><span class="text-blue-600 font-bold text-xl">g</span><span class="text-green-500 font-bold text-xl">l</span><span class="text-red-500 font-bold text-xl">e</span></div>
                <div class="border rounded-full px-4 py-2 shadow-sm text-gray-600 text-sm">ä»•äº‹ åŠ¹ç‡åŒ– ãƒ„ãƒ¼ãƒ«</div>
            </div>`;
        };

        window.forceLocalMode = () => { 
            if(!appData.keys) appData.keys = {}; 
            appData.keys.useLocal = true; 
            localStorage.setItem('story_weaver_v10_config', JSON.stringify({ keys: appData.keys })); 
            location.reload(); 
        };
        
        window.saveSettings = (local) => { 
            appData.keys = { 
                groq: $('key-groq').value.trim(), 
                firebaseRaw: $('firebase-config').value.trim(), 
                useLocal: local,
                midnight: $('midnight-toggle').checked 
            }; 
            localStorage.setItem('story_weaver_v10_config', JSON.stringify({ keys: appData.keys })); 
            location.reload(); 
        };

        // --- Library ---
        async function loadLibrary() { 
            try { 
                const stories = await window.FB.getLibrary(); 
                $('library-list').innerHTML = stories.length ? stories.map(s => {
                    const blurClass = (appData.keys.midnight && s.cover) ? 'blur-[2px] hover:blur-none transition-all' : '';
                    return `<div onclick="openStory('${s.id}')" class="bg-slate-900 rounded-lg overflow-hidden border border-slate-800 shadow relative group active:scale-95 transition-transform cursor-pointer">
                        <div class="aspect-video bg-slate-800 overflow-hidden">
                            <img src="${s.cover || 'https://placehold.co/600x400/1e293b/475569?text=No+Cover'}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 ${blurClass}">
                        </div>
                        <div class="p-3 bg-gray-900">
                            <h3 class="font-bold text-sm text-gray-200 truncate">${s.title}</h3>
                            <p class="text-[10px] text-gray-500 truncate">${s.plot ? s.plot.substring(0,20) : ''}...</p>
                        </div>
                    </div>`;
                }).join('') : '<div class="col-span-2 text-center text-gray-500 mt-10">ç‰©èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; 
            } catch(e) { $('library-list').innerHTML = `<div class="text-red-400 col-span-2 text-xs">Error</div>`; } 
        }

        window.openCreateModal = () => { $('new-title').value=''; $('new-plot').value=''; $('create-modal').classList.remove('hidden'); };
        
        async function startNewStory() { 
            const title = $('new-title').value; 
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"); 
            appData.currentStory = { 
                title, 
                plot: `ã‚¸ãƒ£ãƒ³ãƒ«:${$('new-genre').value}\næ–‡ä½“:${$('new-tone').value}\nè©³ç´°:${$('new-plot').value}`, 
                messages: [], 
                characters: [] 
            }; 
            $('create-modal').classList.add('hidden'); 
            showScreen('char-studio'); 
            renderCharList(); 
        }

        // --- Character Studio ---
        async function aiSuggestChars() { 
            const btn = $('ai-char-btn'); 
            toggleLoading(true, "AIãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è€ƒæ¡ˆä¸­...");
            if(!appData.keys.groq) { toggleLoading(false); return alert("Groqã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"); }

            try {
                const res = await callGroq([{role:"user", content:`Extract main characters from this plot. Return JSON array ONLY: [{name:"Name", prompt:"Appearance description in English (Visual traits only)", body_prompt:"Nude body description (e.g. slim, pale skin)"}]. Plot: ${appData.currentStory.plot}`}]);
                let jsonStr = res.includes('[') ? res.substring(res.indexOf('['), res.lastIndexOf(']')+1) : "[]";
                appData.currentStory.characters = JSON.parse(jsonStr);
                renderCharList();
            } catch(e) { alert("Error: " + e.message); } finally { 
                toggleLoading(false);
                btn.innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i> AIææ¡ˆ (Groq)'; lucide.createIcons(); 
            }
        }

        function renderCharList() { 
            $('char-list').innerHTML = appData.currentStory.characters.map((c,i) => {
                const bodyField = appData.keys.midnight ? 
                    `<textarea class="bg-pink-900/20 w-full text-xs text-pink-300 p-1 rounded resize-none outline-none mt-1 border border-pink-900/30 focus:border-pink-500" rows="2" placeholder="ç´ ä½“(Body): è„±è¡£æ™‚ã®èº«ä½“çš„ç‰¹å¾´..." onchange="appData.currentStory.characters[${i}].body_prompt=this.value">${c.body_prompt || ''}</textarea>` : '';
                return `<div class="bg-gray-900 border border-gray-700 p-3 rounded mb-2 shadow-sm">
                    <input class="bg-transparent accent-text font-bold w-full text-sm mb-1 outline-none" value="${c.name}" onchange="appData.currentStory.characters[${i}].name=this.value">
                    <textarea class="bg-black w-full text-xs text-gray-400 p-1 rounded resize-none outline-none border border-gray-800 focus:border-indigo-500" rows="2" placeholder="å¤–è¦‹(Outer): æœè£…å«ã‚€é€šå¸¸æ™‚ã®å¤–è¦‹..." onchange="appData.currentStory.characters[${i}].prompt=this.value">${c.prompt}</textarea>
                    ${bodyField}
                    ${c.image ? `<img src="${c.image}" class="w-12 h-12 object-cover rounded-full mt-2 border border-gray-600">` : `<button onclick="genCharRef(${i})" class="text-[10px] mt-1 text-pink-400 border border-pink-900 px-2 rounded hover:bg-pink-900/20">ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ</button>`}
                </div>`
            }).join(''); 
        }
        
        window.genCharRef = async (i) => { 
            toggleLoading(true, "ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆä¸­...");
            const c = appData.currentStory.characters[i]; 
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(c.prompt + ", face focus, icon style")}?seed=${Math.floor(Math.random()*9999)}&width=256&height=256&nologo=true&model=flux`; 
            
            const img = new Image();
            img.onload = () => { appData.currentStory.characters[i].image = url; renderCharList(); toggleLoading(false); };
            img.onerror = () => { toggleLoading(false); alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼"); };
            img.src = url;
        };
        
        window.addEmptyChar = () => { appData.currentStory.characters.push({name:"æ–°è¦", prompt:"", body_prompt:""}); renderCharList(); };
        
        async function finishCharSetup() { 
            if(!appData.currentStory.id) appData.currentStory.id = await window.FB.createStory(appData.currentStory); 
            else await window.FB.saveStory(appData.currentStory.id, { characters: appData.currentStory.characters }); 
            showScreen('studio'); 
            if(appData.currentStory.messages.length === 0) generateStoryLogic("ç‰©èªã®å°å…¥ã‚’æ›¸ã„ã¦"); else renderMessages(); 
        }

        // --- Studio & Logic ---
        async function openStory(id) { 
            const s = await window.FB.getStory(id); 
            if(!s) return alert("Not Found"); 
            appData.currentStory = { id, ...s }; 
            showScreen('studio'); 
            renderMessages(); 
        }
        
        $('send-btn').onclick = async () => { 
            const txt = $('user-input').value.trim(); 
            if(!txt) return; 
            $('user-input').value = ''; 
            appData.currentStory.messages.push({role:'user', content:txt}); 
            renderMessages(); 
            await generateStoryLogic(txt); 
        };

        async function generateStoryLogic(inst) { 
            $('send-btn').disabled = true; 
            toggleLoading(true, "AIãŒåŸ·ç­†ä¸­...");
            if(!appData.keys.groq) { $('send-btn').disabled = false; toggleLoading(false); return alert("Groqã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"); }

            try { 
                const isMidnight = appData.keys.midnight;
                const sensoryLevel = isMidnight ? $('sensory-level').value : "1";
                const sensoryInst = {
                    "1": "Write in a standard novel style.",
                    "2": "Focus on sensory details (touch, breath, temperature). Use slightly suggestive language.",
                    "3": "Write with EXPLICIT anatomical details and direct descriptions of actions. NSFW allowed."
                }[sensoryLevel];

                const context = [
                    {role:"system", content:`Novelist. Characters: ${JSON.stringify(appData.currentStory.characters)}. ${sensoryInst}. Language: Japanese.`}, 
                    ...appData.currentStory.messages.slice(-10)
                ]; 
                if(inst) context.push({role:'user', content:inst}); 
                
                const aiText = await callGroq(context); 
                appData.currentStory.messages.push({role:'assistant', content:aiText}); 
                renderMessages(); 
                await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages }); 
                
                // New char detection
                const res = await callGroq([{role:"user", content:`Analyze text. Any NEW named chars not in: [${appData.currentStory.characters.map(c=>c.name).join(',')}]. Return JSON {found:true, name:"...", prompt:"..."} or {found:false}. Text: ${aiText.substring(0,500)}`}]); 
                let jsonStr = res.includes('{') ? res.substring(res.indexOf('{'), res.lastIndexOf('}')+1) : "{}";
                const json = JSON.parse(jsonStr); 
                if(json.found) { appData.pendingNewChar = json; $('new-char-name').innerText = json.name; $('new-char-alert').classList.remove('hidden'); }
            } catch(e) { console.error(e); } finally { 
                $('send-btn').disabled = false; 
                toggleLoading(false);
            } 
        }

        window.acceptNewChar = async () => { if(!appData.pendingNewChar) return; appData.currentStory.characters.push({ name: appData.pendingNewChar.name, prompt: appData.pendingNewChar.prompt }); await window.FB.saveStory(appData.currentStory.id, { characters: appData.currentStory.characters }); $('new-char-alert').classList.add('hidden'); };
        
        async function callGroq(messages) { 
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: {"Authorization": `Bearer ${appData.keys.groq}`, "Content-Type": "application/json"}, body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: messages }) }); 
            if(!res.ok) throw new Error("API Error"); const data = await res.json(); return data.choices[0].message.content; 
        }

        function renderMessages() { 
            const content = $('studio-content');
            content.innerHTML = appData.currentStory.messages.map(m => { 
                const bubble = m.role==='user' ? 'bg-indigo-900/50 text-white ml-auto border border-indigo-800' : 'bg-gray-900 text-gray-300 mr-auto border-l-2 border-indigo-500/50'; 
                
                let html = `<div class="mb-4 fade-in flex ${m.role==='user' ? 'justify-end' : 'justify-start'}">
                                <div class="px-4 py-3 rounded-lg text-sm leading-relaxed max-w-[90%] ${bubble}">
                                    ${m.content.replace(/\n/g,'<br>')}
                                </div>
                            </div>`;
                
                if (m.image) {
                    html = `<div class="flex justify-center mb-4 fade-in">
                                <div class="relative group max-w-full md:max-w-xl">
                                    <img src="${m.image}" class="rounded-lg shadow-lg border border-slate-800 max-h-96 w-auto">
                                    <div class="absolute bottom-2 right-2 bg-black/50 text-[10px] px-1 rounded text-white backdrop-blur">Pollinations</div>
                                </div>
                            </div>` + html;
                }
                return html;
            }).join(''); 
            content.scrollTop = content.scrollHeight; 
        }

        // --- Visual Panel ---
        window.toggleVisualTab = () => { 
            const p = $('visual-panel'); 
            p.classList.toggle('show-panel'); 
            if(p.classList.contains('show-panel')) {
                 const currentChars = appData.currentStory ? appData.currentStory.characters : [];
                 $('visual-char-chips').innerHTML = currentChars.map((c, i) => `<label class="flex items-center gap-2 bg-gray-900 px-3 py-2 rounded border border-gray-700 flex-shrink-0 select-none cursor-pointer"><input type="checkbox" class="char-checkbox accent-pink-500 w-4 h-4" value="${i}"><span class="text-xs text-gray-300 font-bold">${c.name}</span></label>`).join(''); 
            }
        };

        window.generateWithChar = async () => { 
            toggleLoading(true, "ç”»åƒã‚’ç”Ÿæˆä¸­...");
            
            // 1. Settings
            const model = $('visual-model').value;
            const aspectKey = $('visual-aspect').value; 
            const costumeKey = $('visual-costume').value;
            const cameraKey = $('visual-camera').value;
            const customPrompt = $('visual-custom-prompt').value || "";
            const isMidnight = appData.keys.midnight;

            // 2. Size Map
            const sizeMap = { "16:9": { w: 1024, h: 576 }, "9:16": { w: 576, h: 1024 }, "1:1": { w: 1024, h: 1024 }, "4:3": { w: 1024, h: 768 } };
            const size = sizeMap[aspectKey] || sizeMap["16:9"];

            // 3. Modifiers
            let suffix = ", masterpiece, 8k, photorealistic";

            if (isMidnight) {
                suffix += ", uncensored, nsfw"; 
                if (cameraKey === 'face') suffix += ", focus on face, blush, saliva, heavy breathing";
                if (cameraKey === 'pov') suffix += ", looking down, high angle";
                if (cameraKey === 'body') suffix += ", focus on body, skin details";
                if (costumeKey === 'half') suffix += ", disheveled clothes, messy, clothes falling off";
                if (costumeKey === 'lingerie') suffix += ", wearing sexy lingerie, lace";
                if (costumeKey === 'nude') suffix += ", fully nude, naked, nipples, pussy";
            } else {
                 suffix += ", anime style, safe for work"; 
            }

            // 4. Build Character Prompts
            const checked = document.querySelectorAll('.char-checkbox:checked');
            let charPrompts = [];
            
            checked.forEach(cb => {
                const char = appData.currentStory.characters[cb.value];
                const useBody = isMidnight && (costumeKey === 'lingerie' || costumeKey === 'nude');
                let p = useBody ? (char.body_prompt || char.prompt) : char.prompt;
                charPrompts.push(p);
            });

            let finalPrompt = "";
            if (charPrompts.length > 0) {
                finalPrompt = charPrompts.map(p => `(${p})`).join(', ') + `, ${charPrompts.length}people`;
            }

            const fullPrompt = [finalPrompt, customPrompt].filter(Boolean).join(", ") + suffix;
            const seed = Math.floor(Math.random() * 9999);
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?seed=${seed}&width=${size.w}&height=${size.h}&nologo=true&model=${model}`; 

            const imgObj = new Image();
            imgObj.onload = () => {
                const div = document.createElement('div');
                div.className = "relative group mb-4 fade-in";
                div.innerHTML = `<div class="relative"><img src="${url}" class="w-full rounded border border-gray-700 bg-gray-900 min-h-[100px]"><div class="absolute top-2 right-2 bg-black/50 px-2 py-1 rounded text-[10px] text-white backdrop-blur">${isMidnight ? 'ğŸ”' : 'ğŸŸ¢'}</div></div><div class="flex justify-end gap-2 mt-1"><a href="${url}" download class="bg-gray-800 px-2 py-1 rounded text-xs text-gray-300">DL</a><button onclick="insertImage('${url}')" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs">æŒ¿å…¥</button></div>`;
                $('visual-list').prepend(div);
                toggleLoading(false);
            };
            imgObj.onerror = () => {
                toggleLoading(false);
                alert("ç”»åƒç”Ÿæˆã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
            };
            imgObj.src = url;
        };

        window.insertImage = async (url) => { appData.currentStory.messages.push({role:'assistant', content:'(æŒ¿çµµ)', image:url}); renderMessages(); await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages, cover: url }); toggleVisualTab(); };
        window.showScreen = (id) => { 
            ['library','studio','char-studio'].forEach(s => $(`screen-${s}`).classList.add('translate-x-full','hidden')); 
            $(`screen-${id}`).classList.remove('translate-x-full','hidden'); 
            if(id === 'library') loadLibrary(); 
        };
        
        showScreen('library');
    </script>
</body>
</html>
