<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryWeaver v9.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Noto Sans JP', sans-serif; overflow: hidden; }
        .font-serif { font-family: 'Shippori Mincho', serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .book-page { background: #1e293b; color: #cbd5e1; line-height: 2.0; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .char-checkbox:checked + div { border-color: #ec4899; background-color: rgba(236, 72, 153, 0.2); color: #fbcfe8; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col">

    <!-- Header -->
    <header class="h-14 flex-none bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('library')">
            <i data-lucide="library" class="w-5 h-5 text-indigo-400"></i>
            <span class="font-serif font-bold text-lg text-indigo-100">StoryWeaver</span>
            <span class="text-[10px] px-1.5 py-0.5 rounded border border-blue-500/30 text-blue-400">v9.1</span>
        </div>
        <div class="flex gap-3">
            <button id="mode-toggle" class="hidden text-xs px-2 py-1 rounded border border-indigo-500/50 text-indigo-300 flex items-center gap-1">
                <i data-lucide="eye" class="w-4 h-4"></i> View
            </button>
            <button onclick="$('settings-modal').classList.remove('hidden')" class="text-xs text-gray-400 hover:text-white">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Screens -->
    <main class="flex-grow relative overflow-hidden bg-slate-950">
        
        <!-- 1. Library -->
        <div id="screen-library" class="absolute inset-0 overflow-y-auto p-4 space-y-4 z-10 bg-slate-950">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-200">æœ¬æ£š</h2>
                <button onclick="openCreateModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> æ–°è¦ä½œæˆ
                </button>
            </div>
            <div id="library-list" class="grid grid-cols-2 gap-4 pb-20"></div>
        </div>

        <!-- 2. Character Studio -->
        <div id="screen-char-studio" class="absolute inset-0 flex flex-col bg-slate-950 translate-x-full transition-transform duration-300 z-30">
            <div class="p-4 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
                <h2 class="font-bold text-indigo-400 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š</h2>
                <button onclick="finishCharSetup()" class="text-xs bg-indigo-600 px-3 py-1 rounded text-white">åŸ·ç­†ã¸é€²ã‚€</button>
            </div>
            <div class="p-4 bg-slate-900 border-b border-slate-800 space-y-2">
                <p class="text-xs text-gray-400">è¨­å®šã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
                <button onclick="aiSuggestChars()" id="ai-char-btn" class="w-full py-2 bg-slate-800 border border-indigo-500/50 text-indigo-300 rounded text-xs flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> AIææ¡ˆ (Groq)
                </button>
            </div>
            <div id="char-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-20"></div>
            <div class="p-4 pb-safe bg-slate-900 border-t border-slate-800">
                <button onclick="addEmptyChar()" class="w-full py-2 bg-slate-800 text-gray-400 rounded text-xs border border-dashed border-gray-600">+ æ‰‹å‹•ã§è¿½åŠ </button>
            </div>
        </div>

        <!-- 3. Studio -->
        <div id="screen-studio" class="absolute inset-0 flex flex-col bg-slate-950 translate-x-full transition-transform duration-300 z-20">
            <div id="studio-content" class="flex-grow overflow-y-auto p-4 pb-32 font-serif scrollbar-hide"></div>

            <!-- New Char Alert -->
            <div id="new-char-alert" class="absolute bottom-20 left-4 right-4 bg-slate-800 border border-yellow-500/50 p-3 rounded-lg shadow-xl flex items-center justify-between hidden transition-all transform translate-y-10 opacity-0">
                <div class="flex items-center gap-3">
                    <div class="bg-yellow-500/20 p-2 rounded-full text-yellow-400"><i data-lucide="user-plus" class="w-4 h-4"></i></div>
                    <div>
                        <p class="text-xs font-bold text-yellow-100">æ–°ã‚­ãƒ£ãƒ©ç™ºè¦‹: <span id="new-char-name"></span></p>
                        <p class="text-[10px] text-gray-400">ã‚­ãƒ£ã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="$('new-char-alert').classList.add('hidden')" class="text-gray-500 text-xs">ç„¡è¦–</button>
                    <button onclick="acceptNewChar()" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs">è¿½åŠ </button>
                </div>
            </div>

            <!-- Edit Controls -->
            <div id="edit-controls" class="absolute bottom-0 w-full bg-slate-900/95 border-t border-slate-800 backdrop-blur pb-safe transition-transform duration-300">
                <div class="flex gap-2 p-2 overflow-x-auto border-b border-slate-800 scrollbar-hide">
                     <button onclick="openCharStudio()" class="flex-shrink-0 px-3 py-1.5 bg-indigo-900/30 text-indigo-400 border border-indigo-700/50 rounded text-xs flex items-center gap-1">
                        <i data-lucide="users" class="w-3 h-3"></i> ã‚­ãƒ£ã‚¹ãƒˆ
                    </button>
                     <button onclick="branchStory()" class="flex-shrink-0 px-3 py-1.5 bg-green-900/30 text-green-400 border border-green-700/50 rounded text-xs flex items-center gap-1">
                        <i data-lucide="git-branch" class="w-3 h-3"></i> åˆ†å²
                    </button>
                     <button onclick="toggleVisualTab()" class="flex-shrink-0 px-3 py-1.5 bg-pink-900/30 text-pink-400 border border-pink-700/50 rounded text-xs flex items-center gap-1">
                        <i data-lucide="image" class="w-3 h-3"></i> æŒ¿çµµ/ç´ æ
                    </button>
                </div>
                <div class="flex gap-2 p-3">
                    <textarea id="user-input" rows="1" class="flex-grow bg-slate-800 border-none rounded-2xl px-4 py-3 text-sm focus:ring-1 focus:ring-indigo-500 outline-none resize-none" placeholder="æ¬¡ã®å±•é–‹..."></textarea>
                    <button id="send-btn" class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg flex-none">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 4. Visual Panel -->
        <div id="visual-panel" class="absolute inset-x-0 bottom-0 h-[75vh] bg-black border-t border-slate-700 rounded-t-2xl transform translate-y-full transition-transform duration-300 z-40 flex flex-col">
            <div class="p-3 bg-slate-900 flex justify-between items-center rounded-t-2xl">
                <span class="text-xs font-bold text-pink-400 flex items-center gap-2"><i data-lucide="image" class="w-4 h-4"></i> æŒ¿çµµãƒ»ç´ æç”Ÿæˆ</span>
                <button onclick="toggleVisualTab()" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="bg-slate-900 px-3 py-2 border-b border-slate-800 flex gap-2 overflow-x-auto scrollbar-hide">
                <select id="visual-aspect" class="bg-black border border-slate-700 text-xs rounded px-2 py-1 text-gray-300">
                    <option value="16:9">æŒ¿çµµ (16:9)</option>
                    <option value="9:16">ç«‹ã¡çµµ (9:16)</option>
                    <option value="1:1">æ­£æ–¹å½¢ (1:1)</option>
                    <option value="4:3">è¨­å®šç”» (4:3)</option>
                </select>
                <select id="visual-mode" class="bg-black border border-slate-700 text-xs rounded px-2 py-1 text-gray-300">
                    <option value="normal">é€šå¸¸</option>
                    <option value="sheet">è¨­å®šè³‡æ–™</option>
                    <option value="standing">ç«‹ã¡çµµ(ç™½èƒŒæ™¯)</option>
                </select>
            </div>

            <div class="p-2 bg-slate-900 border-b border-slate-800 text-[10px] text-gray-500">ã‚­ãƒ£ãƒ©é¸æŠ (è¤‡æ•°å¯)</div>
            <div class="p-2 bg-slate-900 border-b border-slate-800 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2" id="visual-char-chips"></div>
            
            <div class="p-2 bg-slate-900 border-b border-slate-800 flex gap-2">
                <input id="visual-custom-prompt" class="flex-grow bg-black border border-slate-700 rounded px-2 text-xs" placeholder="çŠ¶æ³ (ä¾‹: ç¬‘ã£ã¦ã„ã‚‹)">
                <button onclick="generateWithChar()" class="bg-pink-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap">æã</button>
            </div>
            <div id="visual-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-safe"></div>
        </div>

    </main>

    <!-- Create Modal (Revived UI) -->
    <div id="create-modal" class="fixed inset-0 z-50 bg-slate-950/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4">
            <h3 class="font-bold text-center text-gray-200">æ–°ã—ã„ç‰©èª</h3>
            
            <div>
                <label class="text-xs text-gray-400">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input id="new-title" class="w-full bg-black border border-slate-700 rounded p-2 text-sm text-white" placeholder="ä¾‹: è»¢ç”Ÿã—ãŸã‚‰ã‚¹ãƒ©ã‚¤ãƒ ã ã£ãŸ">
            </div>

            <!-- Genre Selection (Revived) -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs text-gray-400">ã‚¸ãƒ£ãƒ³ãƒ«</label>
                    <select id="new-genre" class="w-full bg-black border border-slate-700 rounded p-2 text-xs text-white">
                        <option value="ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼">ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option>
                        <option value="ç•°ä¸–ç•Œè»¢ç”Ÿ">ç•°ä¸–ç•Œè»¢ç”Ÿ</option>
                        <option value="SF/ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯">SF/ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯</option>
                        <option value="ç¾ä»£ãƒ‰ãƒ©ãƒ">ç¾ä»£ãƒ‰ãƒ©ãƒ/å­¦åœ’</option>
                        <option value="ãƒ›ãƒ©ãƒ¼/ãƒŸã‚¹ãƒ†ãƒªãƒ¼">ãƒ›ãƒ©ãƒ¼/ãƒŸã‚¹ãƒ†ãƒªãƒ¼</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-400">æ–‡ä½“/ãƒˆãƒ¼ãƒ³</label>
                    <select id="new-tone" class="w-full bg-black border border-slate-700 rounded p-2 text-xs text-white">
                        <option value="æ¨™æº–">æ¨™æº–</option>
                        <option value="ãƒ©ãƒãƒ™é¢¨(è»½å¿«)">ãƒ©ãƒãƒ™é¢¨(è»½å¿«)</option>
                        <option value="æ–‡è±ªé¢¨(é‡åš)">æ–‡è±ªé¢¨(é‡åš)</option>
                        <option value="ãƒ€ãƒ¼ã‚¯/ã‚·ãƒªã‚¢ã‚¹">ãƒ€ãƒ¼ã‚¯/ã‚·ãƒªã‚¢ã‚¹</option>
                        <option value="ã‚³ãƒ¡ãƒ‡ã‚£/ã‚®ãƒ£ã‚°">ã‚³ãƒ¡ãƒ‡ã‚£/ã‚®ãƒ£ã‚°</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400">ã‚ã‚‰ã™ã˜ãƒ»è¦ç´  (è‡ªç”±å…¥åŠ›)</label>
                <textarea id="new-plot" rows="3" class="w-full bg-black border border-slate-700 rounded p-2 text-sm text-white" placeholder="è‡ªç”±ã«è¿½è¨˜ã§ãã¾ã™..."></textarea>
            </div>

            <button onclick="startNewStory()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg">ã‚­ãƒ£ãƒ©è¨­å®šã¸é€²ã‚€</button>
            <button onclick="$('create-modal').classList.add('hidden')" class="w-full py-2 text-gray-500 text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-slate-950/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-center text-gray-200">è¨­å®š</h3>
            <div>
                <label class="text-xs font-bold text-orange-400">ğŸ”¥ Groq API Key</label>
                <input type="password" id="key-groq" class="w-full bg-black border border-slate-700 rounded p-2 mt-1 text-xs">
            </div>
            <div class="bg-slate-800 p-3 rounded border border-yellow-500/30">
                <label class="text-xs font-bold text-yellow-400">âš¡ Firebase Config (JSON)</label>
                <textarea id="firebase-config" rows="5" class="w-full bg-black border border-slate-700 rounded p-2 mt-1 text-[10px] font-mono text-gray-300"></textarea>
            </div>
            <button onclick="saveSettings()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg">ä¿å­˜ã—ã¦å†èµ·å‹•</button>
            <button onclick="$('settings-modal').classList.add('hidden')" class="w-full py-2 text-gray-500 text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        window.FB = { 
            init: (config) => {
                try {
                    const app = initializeApp(config);
                    window.db = getFirestore(app);
                    return true;
                } catch(e) { console.error(e); return false; }
            },
            getLibrary: async () => {
                if(!window.db) return [];
                const q = query(collection(window.db, "stories"), orderBy("updatedAt", "desc"));
                const snap = await getDocs(q);
                return snap.docs.map(d => ({id: d.id, ...d.data()}));
            },
            createStory: async (data) => {
                if(!window.db) return;
                const docRef = await addDoc(collection(window.db, "stories"), {
                    ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                });
                return docRef.id;
            },
            saveStory: async (id, data) => {
                if(!window.db) return;
                await updateDoc(doc(window.db, "stories", id), { ...data, updatedAt: serverTimestamp() });
            },
            getStory: async (id) => {
                if(!window.db) return null;
                const snap = await getDoc(doc(window.db, "stories", id));
                return snap.exists() ? snap.data() : null;
            }
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        lucide.createIcons();
        const $ = (id) => document.getElementById(id);
        
        let appData = { keys: {}, currentStory: null, mode: 'edit', pendingNewChar: null };

        // --- Init ---
        window.addEventListener('firebase-ready', () => {
            const saved = localStorage.getItem('story_weaver_v9_config');
            if(saved) {
                const parsed = JSON.parse(saved);
                appData.keys = parsed.keys;
                $('key-groq').value = appData.keys.groq || '';
                $('firebase-config').value = appData.keys.firebase ? JSON.stringify(appData.keys.firebase, null, 2) : '';
                if(appData.keys.firebase && window.FB.init(appData.keys.firebase)) loadLibrary();
            } else {
                $('settings-modal').classList.remove('hidden');
            }
        });

        window.saveSettings = () => {
            try {
                const fb = JSON.parse($('firebase-config').value);
                const gq = $('key-groq').value;
                localStorage.setItem('story_weaver_v9_config', JSON.stringify({ keys: { groq: gq, firebase: fb } }));
                location.reload();
            } catch(e) { alert("Config Error: " + e.message); }
        };

        async function loadLibrary() {
            $('library-list').innerHTML = '<div class="col-span-2 text-center animate-pulse text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>';
            try {
                const stories = await window.FB.getLibrary();
                if(stories.length === 0) {
                    $('library-list').innerHTML = '<div class="col-span-2 text-center text-gray-500 mt-10">ç‰©èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œæ–°è¦ä½œæˆã€ã‹ã‚‰ã©ã†ãï¼</div>';
                    return;
                }
                $('library-list').innerHTML = stories.map(s => `
                    <div onclick="openStory('${s.id}')" class="bg-slate-900 rounded-lg overflow-hidden border border-slate-800 shadow relative group active:scale-95 transition-transform">
                        <div class="aspect-video bg-slate-800"><img src="${s.cover || 'https://placehold.co/600x400/1e293b/475569?text=No+Cover'}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100"></div>
                        <div class="p-3"><h3 class="font-bold text-sm text-gray-200 truncate">${s.title}</h3></div>
                    </div>`).join('');
            } catch(e) { $('library-list').innerHTML = `<div class="text-red-400 col-span-2">Error: ${e.message}</div>`; }
        }

        window.openCreateModal = () => {
            $('new-title').value = '';
            $('new-plot').value = '';
            $('create-modal').classList.remove('hidden');
        };

        async function startNewStory() {
            const title = $('new-title').value;
            const genre = $('new-genre').value;
            const tone = $('new-tone').value;
            const extra = $('new-plot').value;
            
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            // Combine genre/tone into plot
            const fullPlot = `ã‚¸ãƒ£ãƒ³ãƒ«: ${genre}\næ–‡ä½“: ${tone}\nè©³ç´°: ${extra || 'ç‰¹ã«ãªã—'}`;
            
            appData.currentStory = { title, plot: fullPlot, messages: [], characters: [] };
            $('create-modal').classList.add('hidden');
            showScreen('char-studio');
            renderCharList();
        }

        async function aiSuggestChars() {
            const btn = $('ai-char-btn');
            btn.innerHTML = "è€ƒãˆä¸­...";
            try {
                // Safety check for short input
                const plotText = appData.currentStory.plot.length < 5 ? "Typical fantasy adventure with a hero." : appData.currentStory.plot;

                const res = await callGroq([
                    {role:"user", content:`Extract main characters from this plot. If information is scarce, invent typical characters for the genre.
                    Return JSON array ONLY: [{name:"Name", prompt:"Appearance description in English (hair, eyes, clothes...)"}]. 
                    Plot: ${plotText}`}
                ]);
                
                // Robust JSON parsing
                let jsonStr = res;
                if(res.includes('[')) {
                    jsonStr = res.substring(res.indexOf('['), res.lastIndexOf(']')+1);
                } else {
                    throw new Error("AIãŒJSONå½¢å¼ã§è¿”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
                }
                
                const chars = JSON.parse(jsonStr);
                appData.currentStory.characters = chars;
                renderCharList();
            } catch(e) { alert("AIææ¡ˆã‚¨ãƒ©ãƒ¼: " + e.message); }
            finally { btn.innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i> AIææ¡ˆ (Groq)'; lucide.createIcons(); }
        }

        function renderCharList() {
            const list = $('char-list');
            list.innerHTML = appData.currentStory.characters.map((c, i) => `
                <div class="bg-black border border-slate-700 p-3 rounded flex flex-col gap-2">
                    <div class="flex gap-2 items-start">
                        <div class="flex-grow">
                            <input class="bg-transparent text-indigo-300 font-bold w-full text-sm mb-1 border-b border-transparent focus:border-indigo-500 outline-none" value="${c.name}" onchange="updateChar(${i}, 'name', this.value)">
                            <textarea class="bg-slate-900 w-full text-xs text-gray-400 p-1 rounded resize-none outline-none" rows="2" onchange="updateChar(${i}, 'prompt', this.value)">${c.prompt}</textarea>
                        </div>
                        <button onclick="removeChar(${i})" class="text-gray-600 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="genCharRef(${i}, 'sheet')" class="text-[10px] bg-slate-800 border border-slate-600 px-2 py-1 rounded text-gray-300 hover:text-white">è¨­å®šç”»</button>
                        <button onclick="genCharRef(${i}, 'standing')" class="text-[10px] bg-slate-800 border border-slate-600 px-2 py-1 rounded text-gray-300 hover:text-white">ç«‹ã¡çµµ</button>
                    </div>
                    ${c.image ? `<img src="${c.image}" class="w-full rounded mt-1 border border-slate-800">` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.updateChar = (i, field, val) => appData.currentStory.characters[i][field] = val;
        window.removeChar = (i) => { appData.currentStory.characters.splice(i, 1); renderCharList(); };
        window.addEmptyChar = () => { appData.currentStory.characters.push({name:"æ–°è¦ã‚­ãƒ£ãƒ©", prompt:"appearance..."}); renderCharList(); };

        window.genCharRef = async (i, mode) => {
            const c = appData.currentStory.characters[i];
            let prompt = c.prompt + (mode==='sheet' ? ", character sheet, concept art, three views, white background" : ", solo, full body, standing, simple white background");
            let w = mode==='sheet' ? 1024 : 768;
            let h = mode==='sheet' ? 768 : 1024;
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${Math.floor(Math.random()*99999)}&width=${w}&height=${h}&nologo=true&model=flux`;
            
            const img = new Image(); img.src = url;
            img.onload = () => {
                appData.currentStory.characters[i].image = url;
                renderCharList();
            };
        };

        async function finishCharSetup() {
            if(!appData.currentStory.id) {
                const id = await window.FB.createStory(appData.currentStory);
                appData.currentStory.id = id;
            } else {
                await window.FB.saveStory(appData.currentStory.id, { characters: appData.currentStory.characters });
            }
            showScreen('studio');
            if(appData.currentStory.messages.length === 0) generateFirstScene();
            else renderMessages();
        }

        async function openStory(id) {
            const s = await window.FB.getStory(id);
            if(!s) return;
            appData.currentStory = { id, ...s };
            showScreen('studio');
            renderMessages();
        }

        async function generateFirstScene() {
            $('studio-content').innerHTML = '<div class="text-center animate-pulse mt-20 text-gray-500">ç‰©èªã‚’é–‹å§‹ä¸­...</div>';
            await generateStoryLogic(`ä»¥ä¸‹ã®è¨­å®šã§ç‰©èªã®å°å…¥ã‚’æ›¸ã„ã¦ã€‚\nã‚¿ã‚¤ãƒˆãƒ«:${appData.currentStory.title}\nã‚ã‚‰ã™ã˜:${appData.currentStory.plot}`);
        }

        $('send-btn').onclick = async () => {
            const txt = $('user-input').value.trim();
            if(!txt) return;
            $('user-input').value = '';
            appData.currentStory.messages.push({role:'user', content:txt});
            renderMessages();
            await generateStoryLogic(txt);
        };

        async function generateStoryLogic(instruction) {
            $('send-btn').disabled = true;
            try {
                const context = [
                    {role:"system", content:`ã‚ãªãŸã¯ãƒ—ãƒ­ã®å°èª¬å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©è¨­å®šã‚’è¸ã¾ãˆã¦åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚\n${JSON.stringify(appData.currentStory.characters)}`},
                    ...appData.currentStory.messages.slice(-10)
                ];
                if(instruction) context.push({role:'user', content:instruction});

                const aiText = await callGroq(context);
                appData.currentStory.messages.push({role:'assistant', content:aiText});
                renderMessages();
                await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages });
                
                checkForNewChars(aiText);

            } catch(e) { alert(e.message); }
            finally { $('send-btn').disabled = false; }
        }

        async function checkForNewChars(text) {
            const existingNames = appData.currentStory.characters.map(c => c.name).join(", ");
            try {
                const res = await callGroq([{role:"user", content:`
                    Analyze this text. Are there any NEW important named characters appearing who are NOT in this list: [${existingNames}]?
                    If yes, output JSON: { "found": true, "name": "Name", "prompt": "Appearance description" }.
                    If no, output { "found": false }.
                    Text: ${text.substring(0, 1000)}
                `}]);
                
                let jsonStr = res;
                if(res.includes('{')) jsonStr = res.substring(res.indexOf('{'), res.lastIndexOf('}')+1);
                const json = JSON.parse(jsonStr);
                
                if(json.found) {
                    appData.pendingNewChar = json;
                    $('new-char-name').innerText = json.name;
                    $('new-char-alert').classList.remove('hidden', 'translate-y-10', 'opacity-0');
                }
            } catch(e) { console.log("Scout check failed", e); }
        }

        window.acceptNewChar = async () => {
            if(!appData.pendingNewChar) return;
            appData.currentStory.characters.push({ name: appData.pendingNewChar.name, prompt: appData.pendingNewChar.prompt });
            await window.FB.saveStory(appData.currentStory.id, { characters: appData.currentStory.characters });
            $('new-char-alert').classList.add('hidden');
            alert(`${appData.pendingNewChar.name} ã‚’ã‚­ãƒ£ã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
        };

        async function callGroq(messages) {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: {"Authorization": `Bearer ${appData.keys.groq}`, "Content-Type": "application/json"},
                body: JSON.stringify({ model: "llama3-70b-8192", messages: messages })
            });
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function renderMessages() {
            const c = $('studio-content');
            c.innerHTML = appData.currentStory.messages.map(m => {
                if(appData.mode === 'view' && m.role !== 'assistant') return '';
                const img = m.image ? `<img src="${m.image}" class="w-full md:w-2/3 rounded mb-2 border border-slate-700 block mx-auto shadow-lg">` : '';
                if(appData.mode === 'view') return `<div class="book-page animate-fade-in">${img}<p>${m.content.replace(/\n/g,'<br>')}</p></div>`;
                const bubble = m.role==='user' ? 'bg-indigo-900 text-white ml-auto' : 'bg-slate-900 text-gray-300 mr-auto border-l-2 border-indigo-500/50';
                return `<div class="mb-4 fade-in flex"><div class="px-4 py-3 rounded-lg text-sm leading-relaxed max-w-[90%] ${bubble}">${img}${m.content.replace(/\n/g,'<br>')}</div></div>`;
            }).join('');
            c.scrollTop = c.scrollHeight;
        }

        window.toggleVisualTab = () => {
            const p = $('visual-panel');
            p.style.transform = p.style.transform === 'translateY(0px)' ? 'translateY(100%)' : 'translateY(0px)';
            if(p.style.transform === 'translateY(0px)') {
                $('visual-char-chips').innerHTML = appData.currentStory.characters.map((c, i) => `
                    <label class="flex items-center gap-2 bg-slate-800 px-3 py-2 rounded-lg border border-slate-700 cursor-pointer hover:bg-slate-700 transition-colors flex-shrink-0">
                        <input type="checkbox" class="char-checkbox accent-pink-500 w-4 h-4" value="${i}">
                        <span class="text-xs text-gray-300 select-none">${c.name}</span>
                    </label>
                `).join('');
            }
        };

        window.generateWithChar = async () => {
            const checked = document.querySelectorAll('.char-checkbox:checked');
            let prompts = [], count = 0;
            checked.forEach(cb => { prompts.push(`(${appData.currentStory.characters[cb.value].prompt})`); count++; });

            let finalCharPrompt = "";
            if(count === 1) finalCharPrompt = prompts[0];
            if(count === 2) finalCharPrompt = `${prompts[0]} on the left, ${prompts[1]} on the right, 2people`;
            if(count > 2) finalCharPrompt = `${prompts.join(' and ')}, ${count}people, group shot`;

            const p = $('visual-custom-prompt').value || "scene";
            const aspect = $('visual-aspect').value;
            const mode = $('visual-mode').value;
            
            let w=1024, h=768; 
            if(aspect === '16:9') { w=1024; h=576; } else if(aspect === '9:16') { w=576; h=1024; } else if(aspect === '1:1') { w=1024; h=1024; }

            let suffix = ", masterpiece, best quality, 8k";
            if(mode === 'sheet') suffix += ", character sheet, concept art, three views, white background";
            if(mode === 'standing') suffix += ", full body, standing, simple white background";

            const finalPrompt = `${finalCharPrompt}, ${p}, ${suffix}`;
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?seed=${Math.floor(Math.random()*100000)}&width=${w}&height=${h}&nologo=true&model=flux`;
            
            const div = document.createElement('div');
            div.className = "relative group mb-4";
            div.innerHTML = `<img src="${url}" class="w-full rounded mb-2 border border-slate-700">
                <div class="flex justify-end gap-2"><a href="${url}" download class="bg-slate-800 px-3 py-1 rounded text-xs">DL</a><button onclick="insertImage('${url}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">æŒ¿å…¥</button></div>`;
            $('visual-list').prepend(div);
        };

        window.insertImage = async (url) => {
            appData.currentStory.messages.push({role:'assistant', content:'(æŒ¿çµµ)', image:url});
            renderMessages();
            await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages, cover: url });
            toggleVisualTab();
        };

        window.branchStory = async () => { const newT = prompt("åˆ†å²ã‚¿ã‚¤ãƒˆãƒ«", appData.currentStory.title + " (IF)"); if(!newT)return; const id = await window.FB.createStory({...appData.currentStory, title:newT, id:null}); openStory(id); };
        window.openCharStudio = () => { showScreen('char-studio'); renderCharList(); };
        window.addEmptyChar = () => { appData.currentStory.characters.push({name:"æ–°è¦", prompt:"..."}); renderCharList(); };
        window.showScreen = (id) => { ['library','studio','char-studio'].forEach(s => $(`screen-${s}`).classList.add('translate-x-full','hidden')); if(id==='library')$(`screen-${id}`).classList.remove('hidden'); else $(`screen-${id}`).classList.remove('translate-x-full','hidden'); if(id==='studio')$('mode-toggle').classList.remove('hidden'); else $('mode-toggle').classList.add('hidden'); if(id==='library')loadLibrary(); };
        $('mode-toggle').onclick = () => { appData.mode = appData.mode==='edit'?'view':'edit'; $('mode-toggle').innerHTML=appData.mode==='edit'?'<i data-lucide="eye" class="w-4 h-4"></i> View':'<i data-lucide="edit-3" class="w-4 h-4"></i> Edit'; renderMessages(); };

        showScreen('library');
    </script>
</body>
</html>
