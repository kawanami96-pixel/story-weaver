<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryWeaver v9.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Noto Sans JP', sans-serif; overflow: hidden; }
        .font-serif { font-family: 'Shippori Mincho', serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .book-page { background: #1e293b; color: #cbd5e1; line-height: 2.0; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        /* Loading Spinner Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Error Box */
        #error-toast { position: fixed; top: 1rem; left: 1rem; right: 1rem; background: #7f1d1d; color: #fecaca; padding: 1rem; border-radius: 0.5rem; border: 1px solid #ef4444; z-index: 110; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); font-size: 0.8rem; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner mb-4"></div>
        <p class="text-indigo-300 text-sm font-bold animate-pulse" id="loading-text">Loading...</p>
    </div>

    <!-- Error Toast -->
    <div id="error-toast">
        <div class="font-bold flex items-center gap-2 mb-1"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ</div>
        <div id="error-msg"></div>
        <button onclick="$('error-toast').style.display='none'" class="mt-2 text-xs underline">é–‰ã˜ã‚‹</button>
        <button onclick="$('settings-modal').classList.remove('hidden')" class="mt-2 ml-4 text-xs bg-white text-red-900 px-2 py-1 rounded">è¨­å®šã‚’é–‹ã</button>
    </div>

    <!-- Header -->
    <header class="h-14 flex-none bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showScreen('library')">
            <i data-lucide="library" class="w-5 h-5 text-indigo-400"></i>
            <span class="font-serif font-bold text-lg text-indigo-100">StoryWeaver</span>
            <span id="mode-badge" class="text-[9px] px-1.5 py-0.5 rounded border border-gray-600 text-gray-400">INIT</span>
        </div>
        <div class="flex gap-3">
            <button id="view-mode-btn" class="hidden text-xs px-2 py-1 rounded border border-indigo-500/50 text-indigo-300 flex items-center gap-1">
                <i data-lucide="eye" class="w-4 h-4"></i> View
            </button>
            <button onclick="openSettings()" class="text-xs text-gray-400 hover:text-white">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Screens -->
    <main class="flex-grow relative overflow-hidden bg-slate-950">
        <!-- 1. Library -->
        <div id="screen-library" class="absolute inset-0 overflow-y-auto p-4 space-y-4 z-10 bg-slate-950 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-200">æœ¬æ£š</h2>
                <button onclick="openCreateModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> æ–°è¦ä½œæˆ
                </button>
            </div>
            <div id="library-list" class="grid grid-cols-2 gap-4 pb-20"></div>
        </div>

        <!-- 2. Char Studio -->
        <div id="screen-char-studio" class="absolute inset-0 flex flex-col bg-slate-950 translate-x-full transition-transform duration-300 z-30 hidden">
            <!-- Content same as v9.1 but simplified for brevity in this fix -->
            <div class="p-4 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
                <h2 class="font-bold text-indigo-400 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š</h2>
                <button onclick="finishCharSetup()" class="text-xs bg-indigo-600 px-3 py-1 rounded text-white">åŸ·ç­†ã¸</button>
            </div>
            <div class="p-4 bg-slate-900 border-b border-slate-800 space-y-2">
                <button onclick="aiSuggestChars()" class="w-full py-2 bg-slate-800 border border-indigo-500/50 text-indigo-300 rounded text-xs flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> AIææ¡ˆ (Groq)
                </button>
            </div>
            <div id="char-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-20"></div>
            <div class="p-4 pb-safe bg-slate-900 border-t border-slate-800">
                <button onclick="addEmptyChar()" class="w-full py-2 bg-slate-800 text-gray-400 rounded text-xs border border-dashed border-gray-600">+ è¿½åŠ </button>
            </div>
        </div>

        <!-- 3. Studio -->
        <div id="screen-studio" class="absolute inset-0 flex flex-col bg-slate-950 translate-x-full transition-transform duration-300 z-20 hidden">
            <div id="studio-content" class="flex-grow overflow-y-auto p-4 pb-32 font-serif scrollbar-hide"></div>
            <!-- Alert -->
            <div id="new-char-alert" class="absolute bottom-20 left-4 right-4 bg-slate-800 border border-yellow-500/50 p-3 rounded-lg shadow-xl flex items-center justify-between hidden">
                <div class="text-xs text-yellow-100">æ–°ã‚­ãƒ£ãƒ©ç™ºè¦‹: <span id="new-char-name" class="font-bold"></span></div>
                <button onclick="acceptNewChar()" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">è¿½åŠ </button>
            </div>
            <!-- Controls -->
            <div id="edit-controls" class="absolute bottom-0 w-full bg-slate-900/95 border-t border-slate-800 backdrop-blur pb-safe">
                <div class="flex gap-2 p-2 overflow-x-auto border-b border-slate-800">
                     <button onclick="openCharStudio()" class="flex-shrink-0 px-3 py-1 bg-slate-800 text-indigo-400 rounded text-xs">ã‚­ãƒ£ã‚¹ãƒˆ</button>
                     <button onclick="toggleVisualTab()" class="flex-shrink-0 px-3 py-1 bg-slate-800 text-pink-400 rounded text-xs">æŒ¿çµµ</button>
                </div>
                <div class="flex gap-2 p-3">
                    <textarea id="user-input" rows="1" class="flex-grow bg-slate-800 border-none rounded-2xl px-4 py-3 text-sm focus:ring-1 focus:ring-indigo-500 outline-none resize-none"></textarea>
                    <button id="send-btn" class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

        <!-- 4. Visual Panel -->
        <div id="visual-panel" class="absolute inset-x-0 bottom-0 h-[75vh] bg-black border-t border-slate-700 rounded-t-2xl transform translate-y-full transition-transform duration-300 z-40 flex flex-col">
            <div class="p-3 bg-slate-900 flex justify-between items-center rounded-t-2xl">
                <span class="text-xs font-bold text-pink-400">æŒ¿çµµãƒ»ç´ æ</span>
                <button onclick="toggleVisualTab()" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="bg-slate-900 px-3 py-2 border-b border-slate-800 flex gap-2 overflow-x-auto">
                <select id="visual-aspect" class="bg-black border border-slate-700 text-xs rounded text-gray-300"><option value="16:9">16:9</option><option value="9:16">9:16</option><option value="1:1">1:1</option></select>
                <select id="visual-mode" class="bg-black border border-slate-700 text-xs rounded text-gray-300"><option value="normal">é€šå¸¸</option><option value="sheet">è¨­å®šç”»</option><option value="standing">ç«‹ã¡çµµ</option></select>
            </div>
            <div class="p-2 bg-slate-900 border-b border-slate-800 overflow-x-auto flex gap-2" id="visual-char-chips"></div>
            <div class="p-2 bg-slate-900 border-b border-slate-800 flex gap-2">
                <input id="visual-custom-prompt" class="flex-grow bg-black border border-slate-700 rounded px-2 text-xs" placeholder="çŠ¶æ³">
                <button onclick="generateWithChar()" class="bg-pink-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap">æã</button>
            </div>
            <div id="visual-list" class="flex-grow overflow-y-auto p-4 space-y-4 pb-safe"></div>
        </div>
    </main>

    <!-- Create Modal -->
    <div id="create-modal" class="fixed inset-0 z-50 bg-slate-950/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4">
            <h3 class="font-bold text-center text-gray-200">æ–°è¦ä½œæˆ</h3>
            <input id="new-title" class="w-full bg-black border border-slate-700 rounded p-2 text-sm" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <select id="new-genre" class="w-full bg-black border border-slate-700 rounded p-2 text-xs"><option>ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option><option>SF</option><option>ç¾ä»£</option></select>
            <textarea id="new-plot" rows="3" class="w-full bg-black border border-slate-700 rounded p-2 text-sm" placeholder="ã‚ã‚‰ã™ã˜"></textarea>
            <button onclick="startNewStory()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg">æ¬¡ã¸</button>
            <button onclick="$('create-modal').classList.add('hidden')" class="w-full py-2 text-gray-500 text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-slate-950/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-center text-gray-200">è¨­å®š</h3>
            <div>
                <label class="text-xs font-bold text-orange-400">ğŸ”¥ Groq API Key</label>
                <input type="password" id="key-groq" class="w-full bg-black border border-slate-700 rounded p-2 mt-1 text-xs">
            </div>
            <div class="bg-slate-800 p-3 rounded border border-yellow-500/30">
                <label class="text-xs font-bold text-yellow-400">âš¡ Firebase Config</label>
                <p class="text-[9px] text-gray-400 mb-1">`apiKey` ç­‰ã‚’å«ã‚€ `{...}` ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea id="firebase-config" rows="6" class="w-full bg-black border border-slate-700 rounded p-2 text-[10px] font-mono text-gray-300"></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="saveSettings(false)" class="flex-grow py-3 bg-indigo-600 text-white font-bold rounded-lg text-xs">ä¿å­˜ã—ã¦æ¥ç¶š</button>
                <button onclick="saveSettings(true)" class="flex-grow py-3 bg-slate-700 text-white font-bold rounded-lg text-xs border border-slate-500">ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½¿ã†</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        window.FB = { 
            available: false,
            init: (configObj) => {
                try {
                    const app = initializeApp(configObj);
                    window.db = getFirestore(app);
                    window.FB.available = true;
                    console.log("Firebase initialized");
                    return true;
                } catch(e) { 
                    console.error("Firebase Init Error:", e);
                    throw new Error("Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ConfigãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ (" + e.message + ")");
                }
            },
            // Wrapper methods...
            getLibrary: async () => {
                if(!window.FB.available) return JSON.parse(localStorage.getItem('local_stories') || '[]');
                const q = query(collection(window.db, "stories"), orderBy("updatedAt", "desc"));
                const snap = await getDocs(q);
                return snap.docs.map(d => ({id: d.id, ...d.data()}));
            },
            createStory: async (data) => {
                const now = new Date();
                const storyData = { ...data, createdAt: now, updatedAt: now };
                if(window.FB.available) {
                    const docRef = await addDoc(collection(window.db, "stories"), { ...storyData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    return docRef.id;
                } else {
                    const id = 'local_' + Date.now();
                    const stories = JSON.parse(localStorage.getItem('local_stories') || '[]');
                    stories.unshift({ id, ...storyData });
                    localStorage.setItem('local_stories', JSON.stringify(stories));
                    return id;
                }
            },
            saveStory: async (id, data) => {
                if(window.FB.available && !id.startsWith('local_')) {
                    await updateDoc(doc(window.db, "stories", id), { ...data, updatedAt: serverTimestamp() });
                } else {
                    const stories = JSON.parse(localStorage.getItem('local_stories') || '[]');
                    const idx = stories.findIndex(s => s.id === id);
                    if(idx !== -1) {
                        stories[idx] = { ...stories[idx], ...data, updatedAt: new Date() };
                        localStorage.setItem('local_stories', JSON.stringify(stories));
                    }
                }
            },
            getStory: async (id) => {
                if(window.FB.available && !id.startsWith('local_')) {
                    const snap = await getDoc(doc(window.db, "stories", id));
                    return snap.exists() ? snap.data() : null;
                } else {
                    const stories = JSON.parse(localStorage.getItem('local_stories') || '[]');
                    return stories.find(s => s.id === id) || null;
                }
            }
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        lucide.createIcons();
        const $ = (id) => document.getElementById(id);
        let appData = { keys: {}, currentStory: null, mode: 'edit', pendingNewChar: null };

        function showLoading(show, msg="Loading...") {
            const ol = $('loading-overlay');
            $('loading-text').innerText = msg;
            ol.classList.toggle('hidden', !show);
        }

        function showError(msg) {
            $('error-msg').innerText = msg;
            $('error-toast').style.display = 'block';
            showLoading(false);
        }

        // --- Init ---
        window.addEventListener('firebase-ready', () => {
            initApp();
        });

        async function initApp() {
            showLoading(true, "èµ·å‹•ä¸­...");
            try {
                const saved = localStorage.getItem('story_weaver_v9_config');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    appData.keys = parsed.keys;
                    $('key-groq').value = appData.keys.groq || '';
                    $('firebase-config').value = appData.keys.firebaseRaw || '';

                    // Try Init Firebase if present
                    if(appData.keys.firebaseRaw && !appData.keys.useLocal) {
                        try {
                            // Robust parsing: Handle simple JS object paste
                            let configStr = appData.keys.firebaseRaw.trim();
                            // Wrap in braces if missing
                            if(!configStr.startsWith('{')) configStr = '{' + configStr + '}';
                            // Use Function constructor to parse loose JSON (e.g. keys without quotes)
                            const configObj = (new Function("return " + configStr))();
                            
                            window.FB.init(configObj);
                            updateBadge("CLOUD", "text-green-400", "border-green-600");
                        } catch(e) {
                            console.warn("Firebase Init Failed, falling back to local", e);
                            showError("Firebaseè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚\nè©³ç´°: " + e.message);
                            updateBadge("LOCAL (Error)", "text-red-400", "border-red-600");
                        }
                    } else {
                        updateBadge("LOCAL", "text-gray-400", "border-gray-600");
                    }
                    await loadLibrary();
                } else {
                    $('settings-modal').classList.remove('hidden');
                }
            } catch(e) {
                showError("èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function updateBadge(text, colorClass, borderClass) {
            const b = $('mode-badge');
            b.innerText = text;
            b.className = `text-[9px] px-1.5 py-0.5 rounded border ${colorClass} ${borderClass}`;
        }

        window.openSettings = () => $('settings-modal').classList.remove('hidden');

        window.saveSettings = (useLocal) => {
            const gq = $('key-groq').value.trim();
            const fbRaw = $('firebase-config').value.trim();
            
            appData.keys = { 
                groq: gq, 
                firebaseRaw: fbRaw,
                useLocal: useLocal 
            };
            
            localStorage.setItem('story_weaver_v9_config', JSON.stringify({ keys: appData.keys }));
            location.reload();
        };

        // --- Library ---
        async function loadLibrary() {
            try {
                const stories = await window.FB.getLibrary();
                const list = $('library-list');
                list.innerHTML = '';
                
                if(stories.length === 0) {
                    list.innerHTML = '<div class="col-span-2 text-center text-gray-500 mt-10 text-xs">ã¾ã ç‰©èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œæ–°è¦ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>';
                    return;
                }
                
                list.innerHTML = stories.map(s => `
                    <div onclick="openStory('${s.id}')" class="bg-slate-900 rounded-lg overflow-hidden border border-slate-800 shadow relative group active:scale-95 transition-transform cursor-pointer">
                        <div class="aspect-video bg-slate-800"><img src="${s.cover || 'https://placehold.co/600x400/1e293b/475569?text=No+Cover'}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100"></div>
                        <div class="p-3"><h3 class="font-bold text-sm text-gray-200 truncate">${s.title}</h3></div>
                    </div>`).join('');
            } catch(e) {
                showError("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        // --- Logic (Simplified for stability) ---
        window.openCreateModal = () => { $('new-title').value=''; $('new-plot').value=''; $('create-modal').classList.remove('hidden'); };
        
        async function startNewStory() {
            const title = $('new-title').value;
            const genre = $('new-genre').value;
            const plot = $('new-plot').value;
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            appData.currentStory = { title, plot: `ã‚¸ãƒ£ãƒ³ãƒ«:${genre}\n${plot}`, messages: [], characters: [] };
            $('create-modal').classList.add('hidden');
            showScreen('char-studio');
            renderCharList();
        }

        async function aiSuggestChars() {
            showLoading(true, "AIãŒã‚­ãƒ£ãƒ©ã‚’è€ƒæ¡ˆä¸­...");
            try {
                const res = await callGroq([{role:"user", content:`Extract main characters from this plot. Return JSON array ONLY: [{name:"Name", prompt:"Appearance description in English"}]. Plot: ${appData.currentStory.plot}`}]);
                let jsonStr = res.includes('[') ? res.substring(res.indexOf('['), res.lastIndexOf(']')+1) : "[]";
                appData.currentStory.characters = JSON.parse(jsonStr);
                renderCharList();
            } catch(e) { showError("AIææ¡ˆã‚¨ãƒ©ãƒ¼: " + e.message); }
            finally { showLoading(false); }
        }

        function renderCharList() {
            $('char-list').innerHTML = appData.currentStory.characters.map((c,i) => `
                <div class="bg-black border border-slate-700 p-3 rounded mb-2">
                    <input class="bg-transparent text-indigo-300 font-bold w-full text-sm mb-1 outline-none" value="${c.name}" onchange="appData.currentStory.characters[${i}].name=this.value">
                    <textarea class="bg-slate-900 w-full text-xs text-gray-400 p-1 rounded resize-none outline-none" rows="2" onchange="appData.currentStory.characters[${i}].prompt=this.value">${c.prompt}</textarea>
                    ${c.image ? `<img src="${c.image}" class="w-full rounded mt-2">` : `<button onclick="genCharRef(${i})" class="text-[10px] mt-1 text-pink-400 border border-pink-900 px-2 rounded">ç”»åƒç”Ÿæˆ</button>`}
                </div>
            `).join('');
        }

        window.genCharRef = async (i) => {
            const c = appData.currentStory.characters[i];
            showLoading(true, "ã‚­ãƒ£ãƒ©ç”»åƒã‚’ç”Ÿæˆä¸­...");
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(c.prompt + ", character sheet, white background")}?seed=${Math.floor(Math.random()*9999)}&width=1024&height=768&nologo=true&model=flux`;
            const img = new Image(); img.src = url;
            img.onload = () => { appData.currentStory.characters[i].image = url; renderCharList(); showLoading(false); };
        };

        window.addEmptyChar = () => { appData.currentStory.characters.push({name:"æ–°è¦", prompt:"..."}); renderCharList(); };

        async function finishCharSetup() {
            showLoading(true, "ç‰©èªã‚’ä½œæˆä¸­...");
            try {
                if(!appData.currentStory.id) {
                    const id = await window.FB.createStory(appData.currentStory);
                    appData.currentStory.id = id;
                } else {
                    await window.FB.saveStory(appData.currentStory.id, { characters: appData.currentStory.characters });
                }
                showScreen('studio');
                if(appData.currentStory.messages.length === 0) await generateStoryLogic("ç‰©èªã®å°å…¥ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚");
                else renderMessages();
            } catch(e) { showError("ä½œæˆã‚¨ãƒ©ãƒ¼: " + e.message); }
            finally { showLoading(false); }
        }

        async function openStory(id) {
            showLoading(true, "ç‰©èªã‚’é–‹ã„ã¦ã„ã¾ã™...");
            try {
                const s = await window.FB.getStory(id);
                if(!s) throw new Error("ç‰©èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                appData.currentStory = { id, ...s };
                showScreen('studio');
                renderMessages();
            } catch(e) { showError(e.message); }
            finally { showLoading(false); }
        }

        // Chat & Visual Logic
        $('send-btn').onclick = async () => {
            const txt = $('user-input').value.trim();
            if(!txt) return;
            $('user-input').value = '';
            appData.currentStory.messages.push({role:'user', content:txt});
            renderMessages();
            showLoading(true, "åŸ·ç­†ä¸­...");
            await generateStoryLogic(txt);
            showLoading(false);
        };

        async function generateStoryLogic(instruction) {
            try {
                const context = [
                    {role:"system", content:`Pro novelist. Characters: ${JSON.stringify(appData.currentStory.characters)}`},
                    ...appData.currentStory.messages.slice(-10)
                ];
                if(instruction) context.push({role:'user', content:instruction});
                const aiText = await callGroq(context);
                appData.currentStory.messages.push({role:'assistant', content:aiText});
                renderMessages();
                await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages });
            } catch(e) { showError(e.message); }
        }

        async function callGroq(messages) {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: {"Authorization": `Bearer ${appData.keys.groq}`, "Content-Type": "application/json"},
                body: JSON.stringify({ model: "llama3-70b-8192", messages: messages })
            });
            if(!res.ok) throw new Error("Groq API Error: " + res.status);
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function renderMessages() {
            $('studio-content').innerHTML = appData.currentStory.messages.map(m => {
                if(appData.mode === 'view' && m.role !== 'assistant') return '';
                const img = m.image ? `<img src="${m.image}" class="w-full md:w-2/3 rounded mb-2 border border-slate-700 block mx-auto">` : '';
                const bubble = m.role==='user' ? 'bg-indigo-900 text-white ml-auto' : 'bg-slate-900 text-gray-300 mr-auto border-l-2 border-indigo-500/50';
                return `<div class="mb-4 fade-in flex"><div class="px-4 py-3 rounded-lg text-sm leading-relaxed max-w-[90%] ${bubble}">${img}${m.content.replace(/\n/g,'<br>')}</div></div>`;
            }).join('');
            $('studio-content').scrollTop = $('studio-content').scrollHeight;
        }

        // Visual Panel
        window.toggleVisualTab = () => {
            const p = $('visual-panel');
            const show = p.style.transform !== 'translateY(0px)';
            p.style.transform = show ? 'translateY(0px)' : 'translateY(100%)';
            if(show) {
                $('visual-char-chips').innerHTML = (appData.currentStory.characters||[]).map((c, i) => `
                    <label class="flex items-center gap-2 bg-slate-800 px-3 py-2 rounded border border-slate-700 flex-shrink-0">
                        <input type="checkbox" class="char-checkbox accent-pink-500" value="${i}"><span class="text-xs text-gray-300">${c.name}</span>
                    </label>`).join('');
            }
        };

        window.generateWithChar = async () => {
            const checked = document.querySelectorAll('.char-checkbox:checked');
            let prompts = [], count = 0;
            checked.forEach(cb => { prompts.push(`(${appData.currentStory.characters[cb.value].prompt})`); count++; });
            
            let finalP = count > 0 ? prompts.join(' and ') + ", " : "";
            finalP += $('visual-custom-prompt').value || "scene";
            
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalP + ", masterpiece, 8k")}?seed=${Math.floor(Math.random()*9999)}&width=1024&height=768&nologo=true&model=flux`;
            
            const div = document.createElement('div');
            div.className = "relative group mb-4";
            div.innerHTML = `<img src="${url}" class="w-full rounded border border-slate-700"><div class="flex justify-end gap-2 mt-1"><a href="${url}" download class="bg-slate-800 px-2 py-1 rounded text-xs">DL</a><button onclick="insertImage('${url}')" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs">æŒ¿å…¥</button></div>`;
            $('visual-list').prepend(div);
        };

        window.insertImage = async (url) => {
            appData.currentStory.messages.push({role:'assistant', content:'(æŒ¿çµµ)', image:url});
            renderMessages();
            await window.FB.saveStory(appData.currentStory.id, { messages: appData.currentStory.messages, cover: url });
            toggleVisualTab();
        };

        // Navigation
        window.showScreen = (id) => {
            ['library','studio','char-studio'].forEach(s => $(`screen-${s}`).classList.add('translate-x-full','hidden'));
            if(id==='library')$(`screen-${id}`).classList.remove('hidden'); else $(`screen-${id}`).classList.remove('translate-x-full','hidden');
            if(id==='studio') { $('view-mode-btn').classList.remove('hidden'); } else { $('view-mode-btn').classList.add('hidden'); }
            if(id==='library') loadLibrary();
        };
        $('view-mode-btn').onclick = () => { appData.mode = appData.mode==='edit'?'view':'edit'; $('view-mode-btn').innerHTML=appData.mode==='edit'?'<i data-lucide="eye" class="w-4 h-4"></i> View':'<i data-lucide="edit-3" class="w-4 h-4"></i> Edit'; renderMessages(); };

        showScreen('library');
    </script>
</body>
</html>
